<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Ordini DDD Police</title>
    <style>
        /* --- STILI COMPLETI --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #d9d9d9; min-height: 100vh; padding: 20px; }
        .container { max-width: 1850px; margin: 0 auto; background: rgba(255,255,255,0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 3.5em; font-weight: 500; }
        .header p { opacity: 0.9; font-size: 1.25em; }
        .github-setup { background: linear-gradient(135deg, #333 0%, #24292e 100%); color: white; padding: 20px 30px; border-bottom: 1px solid #444; }
        .setup-status { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; background: #dc3545; }
        .status-indicator.connected { background: #28a745; }
        .setup-form { display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end; }
        .setup-input { padding: 10px 15px; border: 2px solid #444; border-radius: 8px; background: #2d3748; color: white; font-size: 14px; }
        .setup-input:focus { outline: none; border-color: #667eea; }
        .setup-input::placeholder { color: #a0aec0; }
        .cloud-info { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; text-align: center; font-weight: 600; }
        .controls { padding: 20px 30px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; text-decoration: none; display: inline-block; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .filter-input { padding: 10px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; transition: border-color 0.3s ease; }
        .filter-input:focus { outline: none; border-color: #667eea; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 20px; background: #f8f9fa; padding: 20px 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 4px solid; }
        .stat-card.total { border-left-color: #3498db; }
        .stat-card.active { border-left-color: #27ae60; }
        .stat-card.mepa { border-left-color: #f39c12; }
        .stat-card.value { border-left-color: #e74c3c; }
        .stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { color: #666; font-size: 0.9em; }
        .table-container { padding: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        th { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 15px 8px; text-align: left; font-weight: 600; font-size: 0.85em; }
        td { padding: 12px 8px; border-bottom: 1px solid #e9ecef; font-size: 0.85em; }
        tr:hover { background-color: #f8f9fa; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; text-transform: uppercase; }
        .status-attivo { background: #d4edda; color: #27ae60;}
        .status-chiuso { background: #f8d7da; color: #e74c3c;}
        .mepa-si { background: #d1ecf1; color: #0c5460; padding: 4px 8px; border-radius: 12px; font-size: 0.75em; font-weight: bold; }
        .mepa-no { background: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 12px; font-size: 0.75em; font-weight: bold; }
        .modal, .billing-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;
        }
        .modal-content, .billing-modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 700px; max-height: 80%; overflow-y: auto;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .sync-status { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; border-radius: 25px; font-size: 0.9em; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; }
        .sync-status.show { opacity: 1; }
        .sync-status.success { background: #28a745; color: white; }
        .sync-status.error { background: #dc3545; color: white; }
        .sync-status.syncing { background: #ffc107; color: #212529; }
        .currency { text-align: right; font-weight: 600; }
        @media (max-width: 768px) {
            .header p { display: none; }
            .header h1 { font-size: 2em !important; }
            .header img { height: 100px !important; }
            .form-row, .form-row-3, .controls, .setup-form, .stats {
                grid-template-columns: 1fr !important; flex-direction: column !important; align-items: stretch !important;
            }
            .controls button, .controls input, .controls select { width: 100%; margin-bottom: 10px; }
            .table-container { padding: 15px; }
            th, td { font-size: 0.75em; padding: 10px 6px; }
        }
    </style>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
</head>
<body>
    <div class="container">
        <div class="header" style="display: flex; justify-content: center;">
            <header style="display: flex; align-items: center; gap: 15px;">
                <img src="https://www.tachigrafodigitale.net/wp-content/uploads/2024/02/siak-sistemi-logo.svg" style="height: 100px;">  
                <div style="display: flex; flex-direction: column; justify-content: center; height: 100px;">
                    <h1 style="margin: 0; line-height: 1.0;">Rinnovi DDD Police</h1>
                    <p style="margin: 0;">Sistema cloud con sincronizzazione automatica GitHub</p>
                </div>
            </header>
        </div>
        <div class="github-setup">
            <div class="setup-status">
                <div class="status-indicator" id="connectionStatus"></div>
                <span id="connectionText">Disconnesso - Configura GitHub per la sincronizzazione cloud</span>
            </div>
            <div class="setup-form">
                <div>
                    <input type="text" id="githubToken" class="setup-input" placeholder="GitHub Personal Access Token">
                    <small style="color: #a0aec0; display: block; margin-top: 5px;">
                        Crea su: Settings ‚Üí Developer settings ‚Üí Personal access tokens
                    </small>
                </div>
                <div>
                    <input type="text" id="githubRepo" class="setup-input" placeholder="username/repository">
                    <small style="color: #a0aec0; display: block; margin-top: 5px;">
                        Es: mionome/tracker-ordini-pa
                    </small>
                </div>
                <button class="btn btn-secondary" onclick="connectGitHub()">Connetti</button>
            </div>
        </div>
        <div class="cloud-info" id="cloudStatus">
            ‚òÅÔ∏è Modalit√† Offline - I dati verranno sincronizzati quando configurerai GitHub
        </div>
        <div class="controls">
            <button class="btn btn-primary" onclick="openModal()">‚ûï Nuovo Ordine</button>
            <button class="btn btn-success" onclick="exportCSV()">üìä Esporta CSV</button>
            <button class="btn btn-secondary" onclick="forceSync()" id="syncButton" disabled>üîÑ Sincronizza</button>
            <input type="text" class="filter-input" placeholder="üîç Cerca ente, CIG o referente..." onkeyup="filterTable(this.value)">
            <select class="filter-input" onchange="filterByStatus(this.value)">
                <option value="">Tutti gli stati</option>
                <option value="Attivo">Solo attivi</option>
                <option value="Chiuso">Solo chiusi</option>
            </select>
        </div>
        <div class="stats">
            <div class="stat-card total">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Totale Ordini</div>
            </div>
            <div class="stat-card active">
                <div class="stat-number" id="activeCount">0</div>
                <div class="stat-label">Attivi</div>
            </div>
            <div class="stat-card mepa">
                <div class="stat-number" id="mepaCount">0</div>
                <div class="stat-label">Da MEPA</div>
            </div>
            <div class="stat-card value">
                <div class="stat-number" id="totalValue">‚Ç¨0</div>
                <div class="stat-label">Valore Complessivo</div>
            </div>
        </div>
        <div class="table-container">
            <table id="ordersTable">
                <thead>
                   <tr>
                        <th>Ente</th>
                        <th>MEPA</th>
                        <th>Prodotto DDD</th>
                        <th>CIG</th>
                        <th>N¬∞ Determina</th>
                        <th>Data Ordine</th>
                        <th>Durata</th>
                        <th>Prossima Fatturazione</th>
                        <th>Referente</th>
                        <th>Stato</th>
                        <th>Note</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
        <!-- MODALS -->
        <div id="orderModal" class="modal">
            <div class="modal-content">
                <h2 id="modalTitle">Nuovo Ordine</h2>
                <form id="orderForm">
                    <input type="hidden" id="editIndex" value="-1">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ente *</label>
                            <input type="text" id="ente" required>
                        </div>
                        <div class="form-group">
                            <label>MEPA *</label>
                            <select id="mepa" required>
                                <option value="">Seleziona...</option>
                                <option value="SI">SI</option>
                                <option value="NO">NO</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>CIG *</label>
                            <input type="text" id="cig" required>
                        </div>
                        <div class="form-group">
                            <label>N¬∞ Determina *</label>
                            <input type="text" id="determina" required>
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>Tipo Prodotto *</label>
                            <select id="tipoProdotto" required onchange="updatePriceCalculation()">
                                <option value="">Seleziona...</option>
                                <option value="noleggio">Noleggio DDD Police</option>
                                <option value="licenza">Licenza DDD Police</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fascia Popolazione *</label>
                            <select id="fasciaPopolazione" required onchange="updatePriceCalculation()">
                                <option value="">Seleziona...</option>
                                <option value="10K">Fino a 10.000 abitanti</option>
                                <option value="50K">Fino a 50.000 abitanti</option>
                                <option value="100K">Fino a 100.000 abitanti</option>
                                <option value="200K">Fino a 200.000 abitanti</option>
                                <option value="500K">Fino a 500.000 abitanti</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tablet Aggiuntivi</label>
                            <input type="number" id="tabletExtra" min="0" value="0" onchange="updatePriceCalculation()">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>Data Ordine *</label>
                            <input type="date" id="dataOrdine" required onchange="updatePriceCalculation()">
                        </div>
                        <div class="form-group">
                            <label>Durata (anni) *</label>
                            <input type="number" id="durata" step="1" min="1" max="10" required placeholder="es. 1, 2, 3" onchange="updatePriceCalculation()">
                        </div>
                        <div class="form-group">
                            <label>Durata (mesi)</label>
                            <input type="number" id="durataMesi" min="0" max="11" placeholder="0-11" onchange="updatePriceCalculation()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Referente *</label>
                            <input type="text" id="referente" required>
                        </div>
                        <div class="form-group">
                            <label>Stato *</label>
                            <select id="stato" required>
                                <option value="">Seleziona...</option>
                                <option value="Attivo">Attivo</option>
                                <option value="Chiuso">Chiuso</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <textarea id="note" rows="3" placeholder="Note aggiuntive..."></textarea>
                    </div>
                    <div id="pianoFatturazione" style="margin-top: 20px; display: none;">
                        <h3>Piano di Fatturazione</h3>
                        <div id="fatturePreviste" style="background: #f8f9fa; padding: 15px; border-radius: 8px;"></div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                        <button type="button" class="btn" onclick="closeModal()" style="background: #95a5a6; color: white;">Annulla</button>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </div>
                </form>
            </div>
        </div>
        <div id="billingModal" class="billing-modal">
            <div class="billing-modal-content">
                <h3 id="billingModalTitle">Piano Fatturazione</h3>
                <table class="billing-table" id="billingTable">
                    <thead>
                        <tr>
                            <th>N¬∞</th>
                            <th>Data</th>
                            <th>Periodo</th>
                            <th>Importo</th>
                            <th>Stato</th>
                            <th>Azione</th>
                        </tr>
                    </thead>
                    <tbody id="billingTableBody"></tbody>
                </table>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeBillingModal()">Chiudi</button>
                </div>
            </div>
        </div>
        <div id="syncStatus" class="sync-status">
            üíæ Sincronizzato con GitHub
        </div>
<script>
/* === LOGICA JS COMPLETA === */
/* Tutte le funzioni, delegazione, e gestione tracker ordini DDD Police */

/* Variabili principali */
let orders = [];
let githubConfig = { token: '', repo: '', connected: false };
let currentBillingOrderIndex = -1;

/* Listino prezzi aggiornato */
const dddProducts = {
    noleggio: {
        '10K': { price_under3: 2500, price_3plus: 2000 },
        '50K': { price_under3: 3000, price_3plus: 2500 },
        '100K': { price_under3: 3500, price_3plus: 3000 },
        '200K': { price_under3: 4000, price_3plus: 3500 },
        '500K': { price_under3: 5000, price_3plus: 4000 }
    },
    licenza: {
        '10K': { price_under3: 2300, price_3plus: 1800 },
        '50K': { price_under3: 2800, price_3plus: 2300 },
        '100K': { price_under3: 3300, price_3plus: 2800 },
        '200K': { price_under3: 3800, price_3plus: 3300 },
        '500K': { price_under3: 4800, price_3plus: 3800 }
    },
    tabletExtra: { noleggio: 1000, licenza: 800 },
    acquistoTabletIniziale: 1000,
    licenzaAggiuntivaTabletExtra: 800
};

/* Inizializzazione DOM e delegazione eventi dinamici */
document.addEventListener('DOMContentLoaded', function() {
    loadConfig();
    loadData();

    // Delegazione per i pulsanti dinamici tabella/modali
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('action-btn')) {
            const orderIndex = parseInt(e.target.dataset.orderIndex);
            const action = e.target.dataset.action;
            switch(action) {
                case 'edit': openModal(orderIndex); break;
                case 'billing': showBillingModal(orderIndex); break;
                case 'delete': deleteOrder(orderIndex); break;
            }
        }
        if (e.target.classList.contains('billing-action')) {
            const orderIndex = parseInt(e.target.dataset.orderIndex);
            const fatturaIndex = parseInt(e.target.dataset.fatturaIndex);
            toggleFatturazione(orderIndex, fatturaIndex);
        }
        // Chiudi modali cliccando fuori
        const orderModal = document.getElementById('orderModal');
        const billingModal = document.getElementById('billingModal');
        if (e.target === orderModal) closeModal();
        if (e.target === billingModal) closeBillingModal();
    });

    setInterval(() => { if (githubConfig.connected) syncToGitHub(false); }, 120000);
});

/* --- CRUD e sync --- */
function loadConfig() {
    const saved = localStorage.getItem('githubConfig');
    if (saved) {
        githubConfig = JSON.parse(saved);
        if (githubConfig.connected) {
            updateConnectionStatus(true);
            document.getElementById('githubToken').value = githubConfig.token;
            document.getElementById('githubRepo').value = githubConfig.repo;
        }
    }
}
function saveConfig() {
    localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
}
async function loadData() {
    if (githubConfig.connected) await loadFromGitHub();
    else orders = JSON.parse(localStorage.getItem('paOrders') || '[]');
    updateStats(); renderTable();
}
function saveData() {
    localStorage.setItem('paOrders', JSON.stringify(orders));
    if (githubConfig.connected) syncToGitHub(true);
}
async function connectGitHub() {
    const token = document.getElementById('githubToken').value.trim();
    const repo = document.getElementById('githubRepo').value.trim();
    if (!token || !repo) { alert('Inserisci sia il token che il repository'); return; }
    try {
        const response = await fetch(`https://api.github.com/repos/${repo}`, {
            headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
        });
        if (response.ok) {
            githubConfig = { token, repo, connected: true };
            saveConfig(); updateConnectionStatus(true);
            await loadFromGitHub();
            showSyncStatus('‚úÖ Connesso a GitHub!', 'success');
        } else throw new Error('Repository non accessibile');
    } catch (error) { alert('Errore connessione GitHub: ' + error.message); }
}
async function loadFromGitHub() {
    if (!githubConfig.connected) return;
    try {
        const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/orders.json`, {
            headers: { 'Authorization': `token ${githubConfig.token}`, 'Accept': 'application/vnd.github.v3+json' }
        });
        if (response.ok) {
            const data = await response.json();
            const content = JSON.parse(atob(data.content));
            if (content.orders) {
                const localData = JSON.parse(localStorage.getItem('paOrders') || '[]');
                const localTimestamp = localStorage.getItem('lastSync') || '1970-01-01T00:00:00.000Z';
                if (new Date(content.timestamp) > new Date(localTimestamp)) {
                    orders = content.orders;
                    localStorage.setItem('paOrders', JSON.stringify(orders));
                    localStorage.setItem('lastSync', content.timestamp);
                    showSyncStatus('üì• Dati aggiornati da GitHub', 'success');
                } else {
                    orders = localData;
                    await syncToGitHub(false);
                }
            }
        } else {
            orders = JSON.parse(localStorage.getItem('paOrders') || '[]');
        }
    } catch (error) {
        orders = JSON.parse(localStorage.getItem('paOrders') || '[]');
    }
}
async function syncToGitHub(showMessage = false) {
    if (!githubConfig.connected) return;
    if (showMessage) showSyncStatus('üîÑ Sincronizzazione...', 'syncing');
    try {
        const timestamp = new Date().toISOString();
        const dataToSync = { timestamp: timestamp, version: "1.0", orders: orders };
        let sha = null;
        try {
            const existingResponse = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/orders.json`, {
                headers: { 'Authorization': `token ${githubConfig.token}`, 'Accept': 'application/vnd.github.v3+json' }
            });
            if (existingResponse.ok) { const existingData = await existingResponse.json(); sha = existingData.sha; }
        } catch (e) {}
        const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/orders.json`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${githubConfig.token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: `Aggiornamento ordini PA - ${new Date().toLocaleString('it-IT')}`,
                content: btoa(JSON.stringify(dataToSync, null, 2)),
                sha: sha
            })
        });
        if (response.ok) {
            localStorage.setItem('lastSync', timestamp);
            if (showMessage) showSyncStatus('‚úÖ Sincronizzato con GitHub', 'success');
        } else throw new Error('Errore sincronizzazione');
    } catch (error) {
        if (showMessage) showSyncStatus('‚ùå Errore sincronizzazione', 'error');
    }
}
function updateConnectionStatus(connected) {
    const status = document.getElementById('connectionStatus');
    const text = document.getElementById('connectionText');
    const cloudStatus = document.getElementById('cloudStatus');
    const syncButton = document.getElementById('syncButton');
    if (connected) {
        status.classList.add('connected');
        text.textContent = `Connesso a GitHub - ${githubConfig.repo}`;
        cloudStatus.innerHTML = '‚òÅÔ∏è Sincronizzazione Cloud Attiva - I tuoi dati sono al sicuro!';
        cloudStatus.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
        syncButton.disabled = false;
    } else {
        status.classList.remove('connected');
        text.textContent = 'Disconnesso - Configura GitHub per la sincronizzazione cloud';
        cloudStatus.innerHTML = '‚òÅÔ∏è Modalit√† Offline - I dati verranno sincronizzati quando configurerai GitHub';
        cloudStatus.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        syncButton.disabled = true;
    }
}
function showSyncStatus(message, type) {
    const status = document.getElementById('syncStatus');
    status.textContent = message;
    status.className = `sync-status ${type} show`;
    setTimeout(() => { status.classList.remove('show'); }, 3000);
}
function forceSync() { syncToGitHub(true); }

/* --- Calcolo e piano fatturazione --- */
function updatePriceCalculation() {
    const tipo = document.getElementById('tipoProdotto').value;
    const fascia = document.getElementById('fasciaPopolazione').value;
    const durataAnni = parseInt(document.getElementById('durata').value) || 0;
    const durataMesi = parseInt(document.getElementById('durataMesi').value) || 0;
    const tabletExtra = parseInt(document.getElementById('tabletExtra').value) || 0;
    const dataOrdine = document.getElementById('dataOrdine').value;
    let totalValue = 0;
    const durata = durataAnni + (durataMesi / 12);

    if (!tipo || !fascia || durataAnni <= 0) {
        document.getElementById('pianoFatturazione').style.display = 'none';
        window.currentBillingPlan = [];
        return;
    }
    if (tipo === 'noleggio') {
        const priceKey = durata >= 3 ? 'price_3plus' : 'price_under3';
        const basePrice = dddProducts.noleggio[fascia][priceKey];
        const tabletPrice = dddProducts.tabletExtra.noleggio;
        const annualCost = basePrice + (tabletExtra * tabletPrice);
        totalValue = annualCost * durata;
    } else if (tipo === 'licenza') {
        const priceKey = durata >= 3 ? 'price_3plus' : 'price_under3';
        const basePrice = dddProducts.licenza[fascia][priceKey];
        const acquistoTabletCost = dddProducts.acquistoTabletIniziale;
        const licenzaAddTabletCost = dddProducts.licenzaAggiuntivaTabletExtra;
        const annualLicenseFee = basePrice + (tabletExtra * licenzaAddTabletCost);
        totalValue = (annualLicenseFee * durata) + (acquistoTabletCost * (1 + tabletExtra));
    }

    if (dataOrdine) {
        generateBillingPlan(dataOrdine, durata, totalValue, tipo, fascia, tabletExtra, durataAnni, durataMesi);
    } else {
        document.getElementById('pianoFatturazione').style.display = 'none';
        window.currentBillingPlan = [];
    }
}

function generateBillingPlan(dataOrdine, durata, totalValue, tipoProdotto, fascia, tabletExtra, durataAnni, durataMesi) {
    const pianoFatturazioneDiv = document.getElementById('pianoFatturazione');
    const fatturePrevisteDiv = document.getElementById('fatturePreviste');
    pianoFatturazioneDiv.style.display = 'block';
    fatturePrevisteDiv.innerHTML = '';

    let html = '<h4>Riepilogo Fatture:</h4><ul>';
    let currentBillingPlan = [];
    let startDate = new Date(dataOrdine);
    let totalAmount = 0;
    let invoiceNumber = 1;

    // -- PREZZI --
    const priceKey = durata >= 3 ? 'price_3plus' : 'price_under3';
    // NOLEGGIO
    const baseNoleggio = dddProducts.noleggio[fascia][priceKey];
    const noleggioExtra = dddProducts.tabletExtra.noleggio;
    // LICENZA
    const baseLicenza = dddProducts.licenza[fascia][priceKey];
    const licenzaExtra = dddProducts.licenzaAggiuntivaTabletExtra;
    const acquistoTablet = dddProducts.acquistoTabletIniziale * (1 + tabletExtra);

    // --- LOGICA MESI EXTRA ---
    if (durataMesi > 0) {
        // --- PRIMA FATTURA: mesi extra + eventuale acquisto tablet (solo licenza) ---
        let importoPrimo = 0;
        let descrizionePrimo = '';

        if (tipoProdotto === 'noleggio') {
            importoPrimo = ((baseNoleggio + (noleggioExtra * tabletExtra)) / 12) * durataMesi;
            descrizionePrimo = `${durataMesi} mesi noleggio pro-rata`;
        } else if (tipoProdotto === 'licenza') {
            // Acquisto tablet + pro-rata per mesi
            const canoneProRata = ((baseLicenza + (licenzaExtra * tabletExtra)) / 12) * durataMesi;
            importoPrimo = acquistoTablet + canoneProRata;
            descrizionePrimo = `Acquisto tablet (${1 + tabletExtra}) + ${durataMesi} mesi licenza pro-rata`;
        }

        currentBillingPlan.push({
            numero: invoiceNumber++,
            dataScadenza: startDate.toISOString().split('T')[0],
            periodo: descrizionePrimo,
            importo: importoPrimo,
            fatturata: false
        });
        totalAmount += importoPrimo;

        // --- SECONDA FATTURA: 1 gennaio dell'anno successivo ---
        let year = startDate.getFullYear();
        // Se i mesi extra "sfondano" l'anno, prendi l'anno dopo
        let nextYear = year + 1;
        let secondaData = `${nextYear}-01-01`;

        let descrizioneSeconda = tipoProdotto === 'noleggio' ? 'Canone annuale noleggio' : 'Canone annuale licenza';
        let importoSeconda = tipoProdotto === 'noleggio'
            ? (baseNoleggio + (noleggioExtra * tabletExtra))
            : (baseLicenza + (licenzaExtra * tabletExtra));

        currentBillingPlan.push({
            numero: invoiceNumber++,
            dataScadenza: secondaData,
            periodo: descrizioneSeconda,
            importo: importoSeconda,
            fatturata: false
        });
        totalAmount += importoSeconda;

        // --- FATTURE SUCCESSIVE: sempre 1 gennaio degli anni seguenti ---
        for (let i = 1; i < durataAnni; i++) {
            let altriGennaio = `${nextYear + i}-01-01`;
            currentBillingPlan.push({
                numero: invoiceNumber++,
                dataScadenza: altriGennaio,
                periodo: descrizioneSeconda,
                importo: importoSeconda,
                fatturata: false
            });
            totalAmount += importoSeconda;
        }
    } else {
        // --- SOLO ANNI INTERI ---
        // PRIMA FATTURA: data ordine
        let importoPrimo = 0;
        let descrizionePrimo = '';
        if (tipoProdotto === 'noleggio') {
            importoPrimo = baseNoleggio + (noleggioExtra * tabletExtra);
            descrizionePrimo = 'Canone annuale noleggio';
        } else if (tipoProdotto === 'licenza') {
            importoPrimo = acquistoTablet + baseLicenza + (licenzaExtra * tabletExtra);
            descrizionePrimo = `Acquisto tablet (${1 + tabletExtra}) + 1¬∞ anno licenza`;
        }
        currentBillingPlan.push({
            numero: invoiceNumber++,
            dataScadenza: startDate.toISOString().split('T')[0],
            periodo: descrizionePrimo,
            importo: importoPrimo,
            fatturata: false
        });
        totalAmount += importoPrimo;

        // FATTURE SUCCESSIVE: dopo esattamente un anno dalla data ordine
        for (let i = 1; i < durataAnni; i++) {
            let nextDate = new Date(startDate);
            nextDate.setFullYear(nextDate.getFullYear() + i);
            let periodo = tipoProdotto === 'noleggio' ? `${i + 1}¬∞ anno noleggio` : `${i + 1}¬∞ anno licenza`;
            let importo = tipoProdotto === 'noleggio'
                ? (baseNoleggio + (noleggioExtra * tabletExtra))
                : (baseLicenza + (licenzaExtra * tabletExtra));
            currentBillingPlan.push({
                numero: invoiceNumber++,
                dataScadenza: nextDate.toISOString().split('T')[0],
                periodo: periodo,
                importo: importo,
                fatturata: false
            });
            totalAmount += importo;
        }
    }

    // Popola il div con il riepilogo
    if (currentBillingPlan.length > 0) {
        html += '<li>';
        html += currentBillingPlan.map(f => 
            `Fattura ${f.numero}: ${new Date(f.dataScadenza).toLocaleDateString('it-IT')} - ${f.periodo} - <strong>‚Ç¨${f.importo.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong>`
        ).join('</li><li>');
        html += '</li></ul>';
        html += `<h4>Totale Complessivo: ‚Ç¨${totalAmount.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</h4>`;
    } else {
        html += '<li>Nessun piano di fatturazione generato.</li></ul>';
    }

    fatturePrevisteDiv.innerHTML = html;
    window.currentBillingPlan = currentBillingPlan;
}

/* --- Funzioni di utility --- */
function getProductDescription(order) {
    const tipo = order.tipoProdotto === 'noleggio' ? 'Noleggio' : 'Licenza';
    const fascia = order.fasciaPopolazione;
    const extra = order.tabletExtra > 0 ? ` + ${order.tabletExtra} tablet` : '';
    return `${tipo} ${fascia}${extra}`;
}
function getNextBilling(fatture) {
    if (!fatture || fatture.length === 0) {
        return { data: 'N/A', importo: 0, stato: '0/0' };
    }
    const prossima = fatture.find(f => !f.fatturata);
    if (!prossima) return { data: 'Completato', importo: 0, stato: `${fatture.length}/${fatture.length}` };
    const current = fatture.indexOf(prossima) + 1;
    const total = fatture.length;
    return {
        data: prossima.dataScadenza,
        importo: prossima.importo,
        stato: `${current}/${total}`
    };
}
function toggleFatturazione(orderIndex, fatturaIndex) {
    const order = orders[orderIndex];
    const fattura = order.fatture[fatturaIndex];
    if (confirm(`Segnare la fattura ${fattura.numero} come ${fattura.fatturata ? 'NON ' : ''}fatturata?`)) {
        fattura.fatturata = !fattura.fatturata;
        const tutteCompletate = order.fatture.every(f => f.fatturata);
        if (tutteCompletate && order.stato === 'Attivo') {
            order.stato = 'Chiuso';
        } else if (!tutteCompletate && order.stato === 'Chiuso') {
            order.stato = 'Attivo';
        }
        saveData();
        updateStats();
        renderTable();
        updateBillingModal(orderIndex);
    }
}
function showBillingModal(orderIndex) {
    const order = orders[orderIndex];
    if (!order.fatture || order.fatture.length === 0) {
        alert('Nessun piano di fatturazione disponibile per questo ordine');
        return;
    }
    currentBillingOrderIndex = orderIndex;
    const modal = document.getElementById('billingModal');
    const title = document.getElementById('billingModalTitle');
    title.textContent = `Piano Fatturazione - ${order.ente}`;
    updateBillingModal(orderIndex);
    modal.style.display = 'flex';
}
function updateBillingModal(orderIndex) {
    if (orderIndex !== currentBillingOrderIndex) return;
    const order = orders[orderIndex];
    const tbody = document.getElementById('billingTableBody');
    tbody.innerHTML = '';
    order.fatture.forEach((fattura, fatturaIndex) => {
        const row = document.createElement('tr');
        const stato = fattura.fatturata ? '‚úÖ Fatturata' : '‚è≥ Da fatturare';
        const btnClass = fattura.fatturata ? 'cancel' : 'invoice';
        const btnText = fattura.fatturata ? 'Annulla' : 'Fattura';
        row.innerHTML = `
            <td>${fattura.numero}</td>
            <td>${new Date(fattura.dataScadenza).toLocaleDateString('it-IT')}</td>
            <td>${fattura.periodo}</td>
            <td>‚Ç¨${fattura.importo.toLocaleString('it-IT')}</td>
            <td>${stato}</td>
            <td>
                <button class="action-btn billing-action ${btnClass}" 
                        data-order-index="${orderIndex}" 
                        data-fattura-index="${fatturaIndex}">
                    ${btnText}
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}
function closeBillingModal() {
    document.getElementById('billingModal').style.display = 'none';
    currentBillingOrderIndex = -1;
}
function openModal(index = -1) {
    const modal = document.getElementById('orderModal');
    const form = document.getElementById('orderForm');
    const title = document.getElementById('modalTitle');
    if (index >= 0) {
        title.textContent = 'Modifica Ordine';
        const order = orders[index];
        document.getElementById('editIndex').value = index;
        document.getElementById('ente').value = order.ente;
        document.getElementById('mepa').value = order.mepa;
        document.getElementById('tipoProdotto').value = order.tipoProdotto || '';
        document.getElementById('fasciaPopolazione').value = order.fasciaPopolazione || '';
        document.getElementById('tabletExtra').value = order.tabletExtra || 0;
        document.getElementById('cig').value = order.cig;
        document.getElementById('determina').value = order.determina;
        document.getElementById('dataOrdine').value = order.dataOrdine;
        document.getElementById('durata').value = order.durataAnni || Math.floor(order.durata || 0);
        document.getElementById('durataMesi').value = order.durataMesi || 0;
        document.getElementById('referente').value = order.referente;
        document.getElementById('stato').value = order.stato;
        document.getElementById('note').value = order.note || '';
        if (order.fatture && order.fatture.length > 0) {
            window.currentBillingPlan = order.fatture;
            updatePriceCalculation();
        }
    } else {
        title.textContent = 'Nuovo Ordine';
        form.reset();
        document.getElementById('editIndex').value = -1;
        document.getElementById('pianoFatturazione').style.display = 'none';
        window.currentBillingPlan = [];
    }
    modal.style.display = 'block';
}
function closeModal() {
    document.getElementById('orderModal').style.display = 'none';
}

/* --- Submit form ordine --- */
document.getElementById('orderForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const editIndex = parseInt(document.getElementById('editIndex').value);
    const dataOrdine = document.getElementById('dataOrdine').value;
    const durataAnni = parseInt(document.getElementById('durata').value);
    const durataMesi = parseInt(document.getElementById('durataMesi').value) || 0;
    const durata = durataAnni + (durataMesi / 12);
    const tipoProdotto = document.getElementById('tipoProdotto').value;
    const fasciaPopolazione = document.getElementById('fasciaPopolazione').value;
    const tabletExtra = parseInt(document.getElementById('tabletExtra').value) || 0;

    const order = {
        ente: document.getElementById('ente').value,
        mepa: document.getElementById('mepa').value,
        tipoProdotto: tipoProdotto,
        fasciaPopolazione: fasciaPopolazione,
        tabletExtra: tabletExtra,
        cig: document.getElementById('cig').value,
        determina: document.getElementById('determina').value,
        dataOrdine: dataOrdine,
        durata: durata,
        durataAnni: durataAnni,
        durataMesi: durataMesi,
        referente: document.getElementById('referente').value,
        stato: document.getElementById('stato').value,
        note: document.getElementById('note').value,
        fatture: window.currentBillingPlan || []
    };
    if (editIndex >= 0) {
        orders[editIndex] = order;
    } else {
        orders.push(order);
    }
    saveData();
    updateStats();
    renderTable();
    closeModal();
});

/* --- CRUD tabella ordini --- */
function deleteOrder(index) {
    if (confirm('Sei sicuro di voler eliminare questo ordine?')) {
        orders.splice(index, 1);
        saveData();
        updateStats();
        renderTable();
    }
}
function updateStats() {
    const total = orders.length;
    const active = orders.filter(o => o.stato === 'Attivo').length;
    const mepa = orders.filter(o => o.mepa === 'SI').length;
    const totalValue = orders.reduce((sum, o) => sum + (o.valoreTotale || 0), 0);

    document.getElementById('totalCount').textContent = total;
    document.getElementById('activeCount').textContent = active;
    document.getElementById('mepaCount').textContent = mepa;
    document.getElementById('totalValue').textContent = '‚Ç¨' + totalValue.toLocaleString('it-IT', {minimumFractionDigits: 2});
}
function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    orders.forEach((order, index) => {
        const prodottoDesc = order.tipoProdotto ? getProductDescription(order) : 'Prodotto generico';
        const nextBill = getNextBilling(order.fatture || []);
        const durataDisplay = order.durataMesi > 0 ? 
            `${order.durataAnni || Math.floor(order.durata)} anni, ${order.durataMesi} mesi` : 
            `${order.durataAnni || Math.floor(order.durata)} ${(order.durataAnni || Math.floor(order.durata)) === 1 ? 'anno' : 'anni'}`;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${order.ente}</strong></td>
            <td><span class="mepa-${order.mepa.toLowerCase()}">${order.mepa}</span></td>
            <td>${prodottoDesc}</td>
            <td>${order.cig}</td>
            <td>${order.determina}</td>
            <td>${new Date(order.dataOrdine).toLocaleDateString('it-IT')}</td>
            <td>${durataDisplay}</td>
            <td>
                ${nextBill.data === 'Completato' ? 
                    '<span style="color: #28a745;">‚úÖ Completato</span>' : 
                    nextBill.data === 'N/A' ? 
                    '<span style="color: #666;">N/A</span>' :
                    `<strong>${nextBill.stato}</strong><br>‚Ç¨${nextBill.importo.toLocaleString('it-IT')}<br><small>${new Date(nextBill.data).toLocaleDateString('it-IT')}</small>`
                }
            </td>
            <td>${order.referente}</td>
            <td><span class="status-badge status-${order.stato.toLowerCase()}">${order.stato}</span></td>
            <td>${order.note || '-'}</td>
            <td>
                <button class="action-btn edit" data-action="edit" data-order-index="${index}">‚úèÔ∏è</button>
                <button class="action-btn billing" data-action="billing" data-order-index="${index}">üí∞</button>
                <button class="action-btn delete" data-action="delete" data-order-index="${index}">üóëÔ∏è</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}
function filterTable(searchTerm) {
    const rows = document.querySelectorAll('#tableBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
    });
}
function filterByStatus(status) {
    const rows = document.querySelectorAll('#tableBody tr');
    rows.forEach(row => {
        if (!status) {
            row.style.display = '';
            return;
        }
        const statusCell = row.querySelector('.status-badge');
        const rowStatus = statusCell.textContent;
        row.style.display = rowStatus === status ? '' : 'none';
    });
}
function exportCSV() {
    if (orders.length === 0) {
        alert('Nessun dato da esportare');
        return;
    }
    let csv = 'Ente,MEPA,Prodotto,CIG,N¬∞ Determina,Data Ordine,Durata,Prossima Fatturazione,Referente,Stato,Note\n';
    orders.forEach(order => {
        const prodottoDesc = order.tipoProdotto ? getProductDescription(order) : 'Prodotto generico';
        const nextBill = getNextBilling(order.fatture || []);
        const prossimaFatturazione = nextBill.data === 'Completato' ? 'Completato' : 
            nextBill.data === 'N/A' ? 'N/A' :
            new Date(nextBill.data).toLocaleDateString('it-IT');
        const durataExport = order.durataMesi > 0 ? 
            `${order.durataAnni || Math.floor(order.durata)} anni, ${order.durataMesi} mesi` : 
            `${order.durataAnni || Math.floor(order.durata)} anni`;
        const row = [
            `"${order.ente}"`,
            `"${order.mepa}"`,
            `"${prodottoDesc}"`,
            `"${order.cig}"`,
            `"${order.determina}"`,
            `"${order.dataOrdine}"`,
            `"${durataExport}"`,
            `"${prossimaFatturazione}"`,
            `"${order.referente}"`,
            `"${order.stato}"`,
            `"${order.note || ''}"`
        ];
        csv += row.join(',') + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `ordini_pa_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(link.href);
}

// Salva prima di chiudere la pagina
window.addEventListener('beforeunload', function() {
    if (orders.length > 0) saveData();
});
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js').then(function(registration) {
      // Success
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, function(error) {
      // Fail
      console.log('ServiceWorker registration failed: ', error);
    });
  });
}
</script>        
</body>
</html>
